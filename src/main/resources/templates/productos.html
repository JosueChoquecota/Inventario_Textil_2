<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Productos</title>
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
        <style>
            body {
                padding: 2rem;
            }
        </style>
        <script>
            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Conectado: ' + frame);

                // Actualización de productos en tiempo real
                stompClient.subscribe('/topic/productos', function (message) {
                    const data = JSON.parse(message.body);

                    if (data.eliminado) {
                        const row = document.getElementById('producto-' + data.id);
                        if (row)
                            row.remove();
                    } else {
                        updateTable(data);
                    }
                });
            });

            function updateTable(producto) {
                const tbody = document.querySelector("table tbody");
                let row = document.getElementById('producto-' + producto.id);

                if (!row) {
                    row = tbody.insertRow();
                    row.id = 'producto-' + producto.id;
                    row.insertCell(0); // ID
                    row.insertCell(1); // Nombre
                    row.insertCell(2); // Precio
                    row.insertCell(3); // Stock
                    row.insertCell(4); // Acciones
                }

                row.cells[0].innerText = producto.id;
                row.cells[1].innerText = producto.nombre;
                row.cells[2].innerText = producto.precio;
                row.cells[3].innerText = producto.stock;

                row.cells[4].innerHTML = `
                    <button class="btn btn-sm btn-warning me-2" onclick="editarProducto(${producto.id})">Editar</button>
                    <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${producto.id})">Borrar</button>
                `;
            }

            // ----------------------
            // Funciones de edición
            // ----------------------
            function editarProducto(id) {
                const row = document.getElementById('producto-' + id);
                const nombre = row.cells[1].innerText;
                const precio = row.cells[2].innerText;
                const stock = row.cells[3].innerText;

                row.cells[1].innerHTML = `<input class="form-control form-control-sm" value="${nombre}" id="edit-nombre-${id}">`;
                row.cells[2].innerHTML = `<input class="form-control form-control-sm" type="number" step="0.01" value="${precio}" id="edit-precio-${id}">`;
                row.cells[3].innerHTML = `<input class="form-control form-control-sm" type="number" value="${stock}" id="edit-stock-${id}">`;

                row.cells[4].innerHTML = `
                    <button class="btn btn-sm btn-success me-2" onclick="guardarEdicion(${id})">Guardar</button>
                    <button class="btn btn-sm btn-secondary" onclick="cancelarEdicion(${id}, '${nombre}', '${precio}', '${stock}')">Cancelar</button>
                `;
            }

            function guardarEdicion(id) {
                const nombre = document.getElementById(`edit-nombre-${id}`).value;
                const precio = document.getElementById(`edit-precio-${id}`).value;
                const stock = document.getElementById(`edit-stock-${id}`).value;

                fetch(`/productos/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({nombre, precio, stock})
                }).then(response => {
                    if (!response.ok)
                        throw new Error('Error al editar producto');
                }).catch(err => console.error(err));
            }

            function cancelarEdicion(id, nombre, precio, stock) {
                const row = document.getElementById('producto-' + id);
                row.cells[1].innerText = nombre;
                row.cells[2].innerText = precio;
                row.cells[3].innerText = stock;

                row.cells[4].innerHTML = `
                    <button class="btn btn-sm btn-warning me-2" onclick="editarProducto(${id})">Editar</button>
                    <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${id})">Borrar</button>
                `;
            }

            // ----------------------
            // Función eliminar
            // ----------------------
            function eliminarProducto(id) {
                fetch(`/productos/${id}`, {method: 'DELETE'})
                        .then(response => {
                            if (!response.ok)
                                throw new Error('Error al borrar producto');
                            // fila se eliminará automáticamente vía WebSocket
                        })
                        .catch(err => console.error(err));
            }
        </script>
    </head>
    <body>
        <div class="container">

            <h1 class="mb-4">Productos</h1>

            <!-- Formulario para crear productos -->
            <div class="card mb-4">
                <div class="card-body">
                    <form action="/productos/crear" method="post" class="row g-3">
                        <div class="col-md-4">
                            <input class="form-control" name="nombre" placeholder="Nombre" required/>
                        </div>
                        <div class="col-md-3">
                            <input class="form-control" name="precio" type="number" step="0.01" placeholder="Precio" required/>
                        </div>
                        <div class="col-md-3">
                            <input class="form-control" name="stock" type="number" placeholder="Stock" required/>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">Crear</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tabla de productos -->
            <h2 class="mb-3">Lista de productos</h2>
            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="p : ${productos}" th:id="'producto-' + ${p.id}">
                            <td th:text="${p.id}"></td>
                            <td th:text="${p.nombre}"></td>
                            <td th:text="${p.precio}"></td>
                            <td th:text="${p.stock}"></td>
                            <td>
                                <button class="btn btn-warning btn-sm" th:onclick="|editarProducto(${p.id})|">Editar</button>
                                <button class="btn btn-danger btn-sm" th:onclick="|eliminarProducto(${p.id})|">Borrar</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
